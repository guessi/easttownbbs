var curr = 0;
var keyEvent = 0;
var baseurl = "http://bbs.ndhu.edu.tw:8080";

$.ajaxSetup({
  cache : false
});

function checkURL(p) {
  /* 0: not valid, 1: valid */
  return (typeof p != "undefined" && p.length > 0);
}

function highlight(pos) {
  if (pos >= 0 && pos <= 19) {
    $("#curPos").val(pos);
    $(".listitem:not(" + (pos + 1) + ")").removeClass('highlight');
    $(".listitem:nth-child(" + (pos + 1) + ")").addClass("highlight");
  }
}

function loadPage(next, pos) {
  if (pos >= 0 && pos <= 19) {
    $("#content").load(next + " #content").ajaxComplete(function (e, xhr, settings) {
      var loc = (next.charAt(0) == '?') ? (window.location.pathname + next) :
                (next.charAt(0) == '/') ? (baseurl + next) : "";
      if (checkURL(loc)) {
        window.history.pushState("", document.title, loc);
      }
      highlight(pos);
    });
  }
}

function keyEventHandler(key) {
  var link = "";
  /* 1 ~ 20 */
  var ilen = $(".listitem").length;
  /* 0 ~ 19 */
  curr = parseInt($("#curPos").val());
  
  if (key == 66 || key == 98) {
    /* brdlist, [B:66], [b:98] */
    loadPage("/brdlist", 1);
  } else if (key == 67 || key == 99) {
    /* class, [C:67], [c:99] */
    $(location).attr("href", "/class");
  } else if (key == 72 || key == 104) {
    /* hotboard, [M:72], [m:104] */
    loadPage("/hotboard", 1);
  } else if (key == 77 || key == 109) {
    /* home, [M:77], [m:109] */
    $(location).attr("href", "/home");
  } else if (key == 33) {
    /* [PgUp:33] */
    if (ilen > 0) {
      link = $(".cmdPgUp a").attr("href");
      if (checkURL(link)) {
        /* keep current position */
        $("#curPos").val(curr);
        loadPage(link, curr);
      } else {
        curr = 0;
        highlight(curr);
      }
    }
  } else if (key == 34) {
    /* [PgDn:34] */
    if (ilen > 0) {
      link = $(".cmdPgDn a").attr("href");
      if (checkURL(link)) {
        /* keep current position */
        $("#curPos").val(curr);
        loadPage(link, curr);
      } else {
        curr = ilen - 1;
        highlight(curr);
      }
    }
  } else if (key == 35) {
    /* [End:35] */
    if (ilen > 0) {
      link = $(".cmdEnd a").attr("href");
      if (!checkURL(link)) {
        return;
      }
      curr = ilen - 1;
      $("#curPos").val(curr);
      loadPage(link, curr);
    }
  } else if (key == 36) {
    /* [Home:36] */
    if (ilen > 0) {
      link = $(".cmdHome a").attr("href");
      if (!checkURL(link)) {
        return;
      }
      curr = 0;
      $("#curPos").val(curr);
      loadPage(link, curr);
    }
  } else if (key == 37) {
    /* [LEFT:37] */
    link = ($(".upper").length > 0) ? $(".upper a").attr("href") : $(".cmdLeft a").attr("href");
    if (!checkURL(link)) {
      return;
    }
    $(location).attr("href", link);
  } else if (key == 13 || key == 39) {
    /* [RETURN:13] */
    /* [RIGHT:39] */
    if (ilen > 0) {
      link = $(".listitem:nth-child(" + (curr + 1) + ") a.cmdRight").attr("href");
      curr = 0;
      $("#curPos").val(curr);
      if (!checkURL(link)) {
        return;
      }
      loadPage(link, curr);
    }
  } else if (key == 38) {
    /* [UP:38] */
    curr--;
    if (curr < 0) {
      link = $(".cmdPgUp a").attr("href");
      if (!checkURL(link)) {
        return;
      }
      curr = 19;
      $("#curPos").val(curr);
      loadPage(link, curr);
    }
    highlight(curr);
  } else if (key == 40) {
    /* [DOWN:40] */
    curr++;
    if (curr > (ilen - 1)) {
      link = $(".cmdPgDn a").attr("href");
      if (!checkURL(link)) {
        return;
      }
      curr = 0;
      $("#curPos").val(curr);
      loadPage(link, curr);
    }
    highlight(curr);
  }
}

$(function () {
  /* highlight previous selected item */
  highlight(curr);
  /* order: keydown -> keypress -> keyup */
  /* A(65)~Z(90), a(97)~z(122) */
  $(document).keypress(function (e) {
    /* ctrl/alt/shift whould never happend at keyPress */
    var key = e.which ? e.which : (e.keyCode ? e.keyCode : 0);
    if (!keyEvent) {
      keyEventHandler(key);
    }
  });
  
  $(document).keydown(function (e) {
    var ctrlKey = e.CtrlKey;
    var shiftKey = e.shiftKey;
    var altKey = e.altKey;
    if (ctrlKey || shiftKey || altKey) {
      return
    };
    keyEvent = 1;
    var key = e.which ? e.which : (e.keyCode ? e.keyCode : 0);
    keyEventHandler(key);
  });
  
  $(document).keyup(function (e) {
    /* restore */
    keyEvent = 0;
  });
  
  /* mouse move detection */
  $(".listitem").hover(function () {
    $(this).addClass('highlight')
    curr = $(".listitem").index(this);
    $("#curPos").val(curr);
  }, function () {
    $(".listitem:not(" + curr + ")").removeClass('highlight');
  });
  
  /* permanent link */
  $("#plink span input").click(function () {
    $(this).focus().select();
  });
  
  $("#share").click(function () {
    if ($("#share .hidden").css("display") == "none") {
      $("#share .hidden").css("display", "block");
    } else {
      $("#share .hidden").css("display", "none");
    }
  });
  
  /* Google+ */
  gapi.plusone.render("g-plusone", {
    "href" : "http://bbs.ndhu.edu.tw:8080",
    "size" : "medium",
    "align" : "right",
    "annotation" : "bubble"
  });
  
  /* plurk */
  $(".plurk-share").text("±À¨ì¼P®ö").click(function () {
    window.open('http://www.plurk.com/?qualifier=shares&status='
      .concat(encodeURIComponent(location.href))
      .concat(' (').concat(encodeURIComponent(document.title)).concat(')'),
      '_blank');
  });
});

/* Facebook */
(function (d, s, id) {
  var js,
  fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {
    return;
  }
  js = d.createElement(s);
  js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}
  (document, 'script', 'facebook-jssdk'));

/* Disappearing "Scroll to top" link with jQuery and CSS http://briancray.com/2009/10/06/scroll-to-top-link-jquery-css/ */
$(function () {
  var timer;
  var show = false;
  var $box = $('#message a');
  var $window = $(window);
  var top = $(document.body).children(0).position().top;
  
  $window.scroll(function () {
    window.clearTimeout(timer);
    timer = window.setTimeout(function () {
        if ($window.scrollTop() <= top) {
          show = false;
          $box.fadeOut(500);
        } else if (show == false) {
          show = true;
          $box.stop(true, true).show().click(function () {
            $box.fadeOut(500);
          });
        }
      }, 100);
  });
});
